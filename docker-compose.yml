services:
  rules:
    build: ./rules
    ports: ["8000:8000"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Allows Rules to restart others
      - ./game_logs:/app/logs # Mount shared logs
    environment:
      - AGENT1_URL=http://agent1:8002
      - AGENT2_URL=http://agent2:8002
      - GAME_DURATION_SEC=60
    healthcheck:
        # This uses python to check the URL if curl is missing
        test: ["CMD-SHELL", "python3 -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8000/health\")'"]
        interval: 3s
        timeout: 3s
        retries: 10 # Give it more chances to boot
        start_period: 5s # Wait 5s before first check
  arena:
    build: ./arena
    ports: ["8001:8001"]

  agent1:
    build: ./agent
    ports: ["8002:8002"]
    environment:
      - AGENT_NAME=agent1
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - ARENA_URL=http://arena:8001/execute
      - RULES_URL=http://rules:8000
    depends_on:
      rules:
        condition: service_healthy
    volumes:
      - ./game_logs:/app/logs # Mount shared log

  agent2:
    build: ./agent
    ports: ["8003:8002"] # Map to different host port, same container port
    environment:
      - AGENT_NAME=agent2
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - ARENA_URL=http://arena:8001/execute
      - RULES_URL=http://rules:8000
    depends_on:
      rules:
        condition: service_healthy
    volumes:
      - ./game_logs:/app/logs # Mount shared log